{% extends "stats/base.html" %}
{% block title %}{% tr "Маппинг" %}{% endblock %}
{% block body %}
<section class="radix-card p-4 mb-4">
  <h1 class="text-xl font-semibold mb-2">{% tr "Маппинг отображаемых имен" %}</h1>
  {% if notice %}<p class="text-green-300 mb-3">{{ notice }}</p>{% endif %}

  <form method="get" class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4">
    <input name="q" value="{{ selected_query }}" class="radix-input" placeholder="{% tr "Поиск по маппингу" %}" />
    <button class="radix-button" type="submit">{% tr "Фильтр" %}</button>
    <a href="{% url 'mappings-page' %}" class="radix-button-secondary text-center">{% tr "Сбросить" %}</a>
  </form>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
    <div class="radix-card p-4">
      <h2 class="font-semibold mb-2">{% tr "Очереди" %}</h2>
      <form method="post" class="space-y-2">
        {% csrf_token %}
        <input type="hidden" name="mapping_type" value="queue" />
        <select name="system_name" class="radix-input" required>
          <option value="">{% tr "Выберите очередь" %}</option>
          {% for q in queue_options %}<option value="{{ q.value }}">{{ q.label }}</option>{% endfor %}
        </select>
        <input name="display_name" class="radix-input" placeholder="{% tr "Например: Техподдержка" %}" required />
        <div class="flex gap-2">
          <button class="radix-button" type="submit" name="action" value="save">{% tr "Сохранить" %}</button>
          <button class="radix-button-secondary" type="submit" name="action" value="delete">{% tr "Удалить" %}</button>
        </div>
      </form>
      <div class="overflow-auto mt-3 max-h-80">
        <table class="radix-table"><thead><tr><th>{% tr "Системное" %}</th><th>{% tr "Отображаемое" %}</th></tr></thead><tbody>{% for m in queue_mappings %}<tr><td>{{ m.queue_system_name }}</td><td>{{ m.queue_display_name }}</td></tr>{% empty %}<tr><td colspan="2">{% tr "Нет маппинга" %}</td></tr>{% endfor %}</tbody></table>
      </div>
    </div>

    <div class="radix-card p-4">
      <h2 class="font-semibold mb-2">{% tr "Операторы" %}</h2>
      <form method="post" class="space-y-2">
        {% csrf_token %}
        <input type="hidden" name="mapping_type" value="agent" />
        <select name="system_name" class="radix-input" required>
          <option value="">{% tr "Выберите оператора" %}</option>
          {% for a in agent_options %}<option value="{{ a.value }}">{{ a.label }}</option>{% endfor %}
        </select>
        <input name="display_name" class="radix-input" placeholder="{% tr "Например: Иванов И.И." %}" required />
        <div class="flex gap-2">
          <button class="radix-button" type="submit" name="action" value="save">{% tr "Сохранить" %}</button>
          <button class="radix-button-secondary" type="submit" name="action" value="delete">{% tr "Удалить" %}</button>
        </div>
      </form>
      <div class="overflow-auto mt-3 max-h-80">
        <table class="radix-table"><thead><tr><th>{% tr "Системное" %}</th><th>{% tr "Отображаемое" %}</th></tr></thead><tbody>{% for m in agent_mappings %}<tr><td>{{ m.agent_system_name }}</td><td>{{ m.agent_display_name }}</td></tr>{% empty %}<tr><td colspan="2">{% tr "Нет маппинга" %}</td></tr>{% endfor %}</tbody></table>
      </div>
    </div>

    <div class="radix-card p-4">
      <h2 class="font-semibold mb-2">{% tr "Ставка за минуту" %}</h2>
      <form method="post" class="space-y-2">
        {% csrf_token %}
        <input type="hidden" name="mapping_type" value="rate" />
        <select name="system_name" class="radix-input" required>
          <option value="">{% tr "Выберите оператора" %}</option>
          {% for a in agent_options %}<option value="{{ a.value }}">{{ a.label }}</option>{% endfor %}
        </select>
        <input name="rate_per_minute" class="radix-input" type="number" step="0.01" min="0" placeholder="{% tr "Например: 3.50" %}" required />
        <div class="flex gap-2">
          <button class="radix-button" type="submit" name="action" value="save">{% tr "Сохранить" %}</button>
          <button class="radix-button-secondary" type="submit" name="action" value="delete">{% tr "Удалить" %}</button>
        </div>
      </form>
      <div class="overflow-auto mt-3 max-h-80">
        <table class="radix-table"><thead><tr><th>{% tr "Оператор" %}</th><th>{% tr "Ставка/мин" %}</th></tr></thead><tbody>{% for r in payout_rates %}<tr><td>{{ r.agent_display_name }}</td><td>{{ r.rate_per_minute }}</td></tr>{% empty %}<tr><td colspan="2">{% tr "Нет ставок" %}</td></tr>{% endfor %}</tbody></table>
      </div>
    </div>
  </div>
</section>
{% endblock %}
